<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë¶€ê³  ìƒì„¸</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    <style>
  body {
    font-family: sans-serif;
    margin: 20px;
  }

  #imageContainer {
    text-align: center;
    margin-bottom: 20px;
  }

  img {
    max-width: 100%;
    height: auto;
  }

  .section {
    margin-top: 24px;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  .chip {
    display: inline-block;
    padding: 6px 12px;
    background-color: #eee;
    margin: 4px;
    border-radius: 20px;
  }
</style>

  </style>
</head>
<body>
  <h2 id="ripTitle">ë¶€ê³  ìƒì„¸</h2>
  <div id="imageContainer"></div>
  <div id="bugoInfo" class="section"></div>
  <div id="relationSection" class="section">
    <h3>ê´€ê³„ì ëª©ë¡</h3>
    <div id="relations"></div>
  </div>

  <script type="module">
    const supabaseUrl = 'https://ytcaqevwiavipcrwktkp.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0Y2FxZXZ3aWF2aXBjcndrdGtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDc4NzMsImV4cCI6MjA2MzI4Mzg3M30._f39Tlq3P9DWN8Co7KbxhPx6ypAr7zGAkI8JnL_c5v8'; // ì—¬ê¸°ì— ì‹¤ì œ anon í‚¤ ì…ë ¥
    const { createClient } = supabase;
    const client = createClient(supabaseUrl, supabaseKey);

    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');

    if (!id) {
      document.body.innerHTML = '<p>ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. IDê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      throw new Error('Missing id parameter');
    }

    async function loadDetail() {
      const { data: detail, error } = await client
        .from('bugoaddlist')
        .select('*')
        .eq('id', id)
        .single();

      console.log('ğŸŸ¢ detail:', detail);
      console.log('ğŸ”´ error:', error);

      if (error || !detail) {
        document.getElementById('bugoInfo').innerText = 'ë¶€ê³  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        return;
      }

      document.getElementById('ripTitle').innerText = `æ•… ${detail.ripname}`;

      if (detail.imagePath) {
        const { data, error: urlError } = await client.storage
          .from('bugoaddphoto')
          .createSignedUrl(detail.imagePath, 60 * 30);

        if (data?.signedUrl) {
          const img = document.createElement('img');
          img.src = data.signedUrl;
          document.getElementById('imageContainer').appendChild(img);
        } else {
          console.error('ğŸ”´ ì´ë¯¸ì§€ URL ì˜¤ë¥˜:', urlError);
        }
      }

      const infoHtml = `
        <p>ê³ ì¸ ì´ë¦„: ${detail.ripname}</p>
        <p>ì‚¬ë§ ìœ í˜•: ${detail.deathtype}</p>
        <p>ì„±ë³„: ${detail.ripsex}</p>
        <p>ì¼ì1: ${detail.date1}</p>
        <p>ì¼ì2: ${detail.date2}</p>
        <p>ì¼ì3: ${detail.date3}</p>
        <p>ì¥ì†Œ: ${detail.location}</p>
        <p>ê³„ì¢Œ: ${detail.account}</p>
        <p>ì¶”ê°€ì •ë³´: ${detail.extra}</p>
      `;
      document.getElementById('bugoInfo').innerHTML = infoHtml;

      await loadRelations();
    }

    async function loadRelations() {
      const container = document.getElementById('relations');
      container.innerHTML = '';

      const { data: relations, error } = await client
        .from('bugorelationship')
        .select('*')
        .eq('bugoaddlist_id', id)
        .eq('is_deleted', false);

      if (error || !relations || relations.length === 0) {
        container.innerText = 'ê´€ê³„ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.';
        return;
      }

      const grouped = {};
      for (const rel of relations) {
        const relation = rel.relationship || 'ê¸°íƒ€';
        if (!grouped[relation]) grouped[relation] = [];
        grouped[relation].push(rel.name);
      }

      for (const relation in grouped) {
        const groupDiv = document.createElement('div');
        groupDiv.innerHTML = `<strong>ê´€ê³„: ${relation}</strong> `;
        grouped[relation].forEach(name => {
          const chip = document.createElement('span');
          chip.className = 'chip';
          chip.textContent = name;
          groupDiv.appendChild(chip);
        });
        container.appendChild(groupDiv);
      }
    }

    loadDetail();
  </script>
</body>
</html>
